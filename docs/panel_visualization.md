# Panel Visualization Tool

## Overview

The `panel_v1_vs_truth.py` tool generates side-by-side comparison panels to visually assess the quality of synthetic optical imagery generated by the Stage 1 model.

## Features

### Three-Panel Layout

1. **Left Panel: Synthetic Optical (v1)**
   - Generated optical imagery from SAR input
   - RGB composite (R=B04, G=B03, B=B02)
   - Shows overall color and texture quality

2. **Middle Panel: Ground Truth S2**
   - Real Sentinel-2 optical imagery
   - Same RGB composite for direct comparison
   - Reference for assessing generation quality

3. **Right Panel: v1 + SAR Edge Overlay**
   - Synthetic optical with SAR edges overlaid in yellow
   - Helps assess edge preservation from SAR input
   - Shows how well structural features are maintained

## Installation

Required packages (should already be installed):
```bash
pip install numpy matplotlib opencv-python
```

## Usage

### Basic Usage

Process all tiles in a directory:
```bash
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/
```

This will:
1. Find all `.npz` tile files in `tiles/`
2. Look for corresponding `*_opt_v1.npz` files
3. Generate comparison panels in `panels/`
4. Save as PNG files with names like `tile001_panel.png`

### Process Specific Tiles

```bash
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/ \
  --tile-ids tile001 tile002 tile003
```

### High-Quality Output

For publication or detailed analysis:
```bash
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels_hq/ \
  --dpi 300 \
  --format pdf
```

### Adjust Edge Sensitivity

Control how many SAR edges are shown:
```bash
# More edges (lower threshold)
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/ \
  --edge-threshold 0.05

# Fewer edges (higher threshold)
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/ \
  --edge-threshold 0.15
```

Default threshold: `0.1`

### Custom Figure Size

```bash
# Larger panels
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/ \
  --figsize 24 8

# Smaller panels
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/ \
  --figsize 12 4
```

Default size: `18 6` inches (width × height)

## Command-Line Arguments

### Required
- `--tile-dir`: Directory containing tile NPZ files (with SAR and S2 data)
- `--output-dir`: Directory to save panel images

### Optional
- `--tile-ids`: Specific tile IDs to process (space-separated)
- `--opt-v1-suffix`: Suffix for opt_v1 files (default: `_opt_v1`)
- `--edge-threshold`: SAR edge detection threshold, 0.0-1.0 (default: `0.1`)
- `--figsize`: Figure size in inches, width height (default: `18 6`)
- `--dpi`: Output resolution (default: `100`)
- `--format`: Output format: png, jpg, pdf, svg (default: `png`)

## Workflow Example

### Step 1: Generate Synthetic Optical

First, run inference on your tiles:
```bash
python scripts/infer_stage1.py \
  --input-dir tiles/ \
  --checkpoint checkpoints/stage1/best_model.pt \
  --batch-size 4
```

This creates `tile001_opt_v1.npz`, `tile002_opt_v1.npz`, etc.

### Step 2: Generate Comparison Panels

```bash
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/
```

### Step 3: Review Panels

Open the generated panels in `panels/` directory:
- `tile001_panel.png`
- `tile002_panel.png`
- ...

## Output Format

### Panel Layout

```
┌────────────────────┬────────────────────┬────────────────────┐
│                    │                    │                    │
│  Synthetic Optical │  Ground Truth S2   │   v1 + SAR Edges   │
│       (v1)         │                    │                    │
│                    │                    │  [Yellow edges]    │
│                    │                    │                    │
└────────────────────┴────────────────────┴────────────────────┘
              Tile: tile001 - Quality Comparison
    Image size: 256×256 | Edge threshold: 0.100 | RGB: R=B04, G=B03, B=B02
```

### File Naming

Output files are named: `{tile_id}_panel.{format}`

Examples:
- `tile001_panel.png`
- `tile002_panel.pdf`
- `urban_scene_001_panel.jpg`

## Understanding the Visualization

### What to Look For

#### 1. Color and Texture Quality (Left vs Middle)
- **Good**: Similar colors, realistic textures
- **Issues**: 
  - Oversaturation or desaturation
  - Blurry or overly smooth textures
  - Incorrect land cover colors

#### 2. Structural Alignment (Right Panel)
- **Good**: Yellow edges align with image features
- **Issues**:
  - Edges don't match visible structures
  - Missing edges for obvious features
  - Spurious edges in uniform areas

#### 3. Overall Realism
- Does the synthetic image look like real satellite imagery?
- Are fine details preserved?
- Is there proper variation in textures?

### SAR Edge Overlay

The yellow edges show structural features extracted from the input SAR:
- Roads, buildings, field boundaries
- Coastlines, rivers
- Forest edges, urban boundaries

**Purpose**: Verify that the generated optical imagery preserves these structural features from the SAR input.

## Technical Details

### RGB Composite

The tool creates RGB composites using:
- **Red channel**: Sentinel-2 Band 4 (665 nm, red)
- **Green channel**: Sentinel-2 Band 3 (560 nm, green)
- **Blue channel**: Sentinel-2 Band 2 (490 nm, blue)

This is a natural color composite similar to human vision.

### Contrast Enhancement

Applies 2nd-98th percentile stretching for better contrast:
1. Calculates 2nd and 98th percentiles for each band
2. Stretches values to fill [0, 1] range
3. Clips outliers for consistent visualization

### SAR Edge Detection

Uses Sobel edge detection on combined VV+VH polarizations:
1. Normalize SAR data to [0, 1]
2. Combine: `0.6 × VV + 0.4 × VH`
3. Apply Sobel filters (horizontal and vertical)
4. Calculate edge magnitude: `√(Sx² + Sy²)`
5. Threshold to create binary edge map

## Examples

### Example 1: Batch Processing

Process all tiles after training:
```bash
# Run inference
python scripts/infer_stage1.py \
  --input-dir tiles/val/ \
  --checkpoint checkpoints/stage1/best_model.pt

# Generate panels
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/val/ \
  --output-dir panels/validation/

# Result: panels/validation/tile*_panel.png
```

### Example 2: Select Best/Worst Cases

```bash
# Visually inspect and select interesting tiles
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/ \
  --output-dir panels/selected/ \
  --tile-ids urban_001 forest_023 coastal_045
```

### Example 3: High-Resolution for Paper

```bash
# Generate publication-quality figures
python tools/panel_v1_vs_truth.py \
  --tile-dir tiles/paper_examples/ \
  --output-dir figures/ \
  --dpi 300 \
  --format pdf \
  --figsize 20 7
```

### Example 4: Edge Analysis

```bash
# Multiple edge thresholds for comparison
for thresh in 0.05 0.10 0.15 0.20; do
  python tools/panel_v1_vs_truth.py \
    --tile-dir tiles/ \
    --output-dir panels/edges_${thresh}/ \
    --edge-threshold $thresh \
    --tile-ids sample_tile
done
```

## Troubleshooting

### No panels generated

**Problem**: Script exits with "No panels generated"

**Solutions**:
1. Check that tile directory exists: `ls tiles/`
2. Verify opt_v1 files exist: `ls tiles/*_opt_v1.npz`
3. Run inference first: `python scripts/infer_stage1.py --input-dir tiles/ --checkpoint ...`

### opt_v1 not found

**Problem**: Message "⚠️ tile001: opt_v1 not found, skipping"

**Solutions**:
1. Check opt_v1 filename suffix matches: default is `_opt_v1`
2. If using different suffix, use: `--opt-v1-suffix _synthetic`
3. Verify file exists: `ls tiles/tile001_opt_v1.npz`

### Edges not visible

**Problem**: Yellow edges too faint or missing

**Solutions**:
1. Lower threshold: `--edge-threshold 0.05` (more edges)
2. Check SAR data quality in input tiles
3. Try different tiles - some scenes have more edges than others

### Poor image quality

**Problem**: Panels look blurry or pixelated

**Solutions**:
1. Increase DPI: `--dpi 150` or `--dpi 200`
2. Increase figure size: `--figsize 24 8`
3. Use vector format: `--format pdf` or `--format svg`

### Memory issues

**Problem**: Out of memory when processing many tiles

**Solutions**:
1. Process tiles in batches: `--tile-ids tile001 tile002 ...`
2. Reduce DPI: `--dpi 75`
3. Reduce figure size: `--figsize 12 4`

## Performance

### Processing Speed

Typical performance on modern hardware:
- **Small tiles (256×256)**: ~1-2 seconds per panel
- **Large tiles (512×512)**: ~2-4 seconds per panel
- **High DPI (300)**: ~2-3× slower

### File Sizes

Approximate output file sizes:
- **PNG @ 100 DPI**: 500KB - 2MB per panel
- **PNG @ 300 DPI**: 2MB - 8MB per panel
- **PDF @ 300 DPI**: 1MB - 4MB per panel
- **JPG**: 30-50% smaller than PNG (lossy)

## Integration with Workflow

### 1. Training Validation

Monitor model quality during training:
```bash
# Every 5000 steps
python scripts/infer_stage1.py --input-dir tiles/val_sample/ --checkpoint checkpoints/step_5000.pt
python tools/panel_v1_vs_truth.py --tile-dir tiles/val_sample/ --output-dir panels/step_5000/
```

### 2. Model Comparison

Compare different model checkpoints:
```bash
for ckpt in checkpoint_10k checkpoint_20k checkpoint_30k; do
  python scripts/infer_stage1.py --input-dir tiles/ --checkpoint checkpoints/${ckpt}.pt --output-suffix _${ckpt}
  python tools/panel_v1_vs_truth.py --tile-dir tiles/ --output-dir panels/${ckpt}/ --opt-v1-suffix _${ckpt}
done
```

### 3. Quality Assessment

Generate panels for validation set:
```bash
# Full validation set
python scripts/infer_stage1.py --input-dir tiles/val/ --checkpoint checkpoints/best_model.pt
python tools/panel_v1_vs_truth.py --tile-dir tiles/val/ --output-dir panels/validation_final/

# Review and select best/worst examples
# Use for paper, presentations, debugging
```

## See Also

- `scripts/infer_stage1.py` - Generate synthetic optical imagery
- `tools/metrics.py` - Compute quantitative metrics
- `docs/early_stopping.md` - Training optimization guide

## Tips

1. **Start with defaults** - They work well for most cases
2. **Adjust edge threshold** based on your scene type:
   - Urban: 0.10-0.15 (many edges)
   - Rural: 0.05-0.10 (fewer edges)
   - Water: 0.15-0.20 (very few edges)
3. **Use PDF format** for presentations and papers
4. **Process validation set** after each major training milestone
5. **Keep panels organized** by checkpoint/experiment for easy comparison
